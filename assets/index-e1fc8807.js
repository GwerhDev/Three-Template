import*as r from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";import{FBXLoader as p}from"https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/FBXLoader.js";import{OrbitControls as m}from"https://cdn.jsdelivr.net/npm/three@0.118/examples/jsm/controls/OrbitControls.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class w{constructor(t){this._animations=t}get animations(){return this._animations}}class f{constructor(t){this._Init(t)}_Init(t){this._params=t,this._decceleration=new r.Vector3(-5e-4,-1e-4,-5),this._acceleration=new r.Vector3(1,.25,50),this._velocity=new r.Vector3(0,0,0),this._animations={},this._input=new y,this._stateMachine=new k(new w(this._animations)),this._LoadModels()}_LoadModels(){const t=new p;t.setPath("./src/models/characters/XBot/"),t.load("X_Bot.fbx",e=>{e.scale.setScalar(.1),e.traverse(a=>{a.castShadow=!0}),this._target=e,this._params.scene.add(this._target),this._mixer=new r.AnimationMixer(this._target),this._manager=new r.LoadingManager,this._manager.onLoad=()=>{this._stateMachine.SetState("idle")};const i=(a,n)=>{const o=n.animations[0],h=this._mixer.clipAction(o);this._animations[a]={clip:o,action:h}},s=new p(this._manager);s.setPath("./src/models/characters/XBot/animations/"),s.load("Walking.fbx",a=>{i("walk",a)}),s.load("Running_Backward.fbx",a=>{i("walk_backward",a)}),s.load("Running.fbx",a=>{i("run",a)}),s.load("Running_Backward.fbx",a=>{i("run_backward",a)}),s.load("Idle.fbx",a=>{i("idle",a)})})}Update(t){if(!this._target)return;this._stateMachine.Update(t,this._input);const e=this._velocity,i=new r.Vector3(e.x*this._decceleration.x,e.y*this._decceleration.y,e.z*this._decceleration.z);i.multiplyScalar(t),i.z=Math.sign(i.z)*Math.min(Math.abs(i.z),Math.abs(e.z)),e.add(i);const s=this._target,a=new r.Quaternion,n=new r.Vector3,o=s.quaternion.clone(),h=this._acceleration.clone();this._input._keys.shift&&h.multiplyScalar(2),this._input._keys.forward&&(e.z+=h.z*t),this._input._keys.backward&&(e.z-=h.z*t),this._input._keys.left&&(n.set(0,1,0),a.setFromAxisAngle(n,4*Math.PI*t*this._acceleration.y),o.multiply(a)),this._input._keys.right&&(n.set(0,1,0),a.setFromAxisAngle(n,4*-Math.PI*t*this._acceleration.y),o.multiply(a)),s.quaternion.copy(o);const l=new r.Vector3;l.copy(s.position);const d=new r.Vector3(0,0,1);d.applyQuaternion(s.quaternion),d.normalize();const _=new r.Vector3(1,0,0);_.applyQuaternion(s.quaternion),_.normalize(),_.multiplyScalar(e.x*t),d.multiplyScalar(e.z*t),s.position.add(d),s.position.add(_),l.copy(s.position),this._mixer&&this._mixer.update(t)}}class y{constructor(){this._Init()}_Init(){this._keys={forward:!1,backward:!1,left:!1,right:!1,space:!1,shift:!1},document.addEventListener("keydown",t=>this._onKeyDown(t),!1),document.addEventListener("keyup",t=>this._onKeyUp(t),!1)}_onKeyDown(t){switch(t.keyCode){case 87:this._keys.forward=!0;break;case 65:this._keys.left=!0;break;case 83:this._keys.backward=!0;break;case 68:this._keys.right=!0;break;case 16:this._keys.shift=!0;break}}_onKeyUp(t){switch(t.keyCode){case 87:this._keys.forward=!1;break;case 65:this._keys.left=!1;break;case 83:this._keys.backward=!1;break;case 68:this._keys.right=!1;break;case 16:this._keys.shift=!1;break}}}class g{constructor(){this._states={},this._currentState=null}_AddState(t,e){this._states[t]=e}SetState(t){const e=this._currentState;if(e){if(e.Name==t)return;e.Exit()}const i=new this._states[t](this);this._currentState=i,i.Enter(e)}Update(t,e){this._currentState&&this._currentState.Update(t,e)}}class k extends g{constructor(t){super(),this._proxy=t,this._Init()}_Init(){this._AddState("idle",b),this._AddState("walk",S),this._AddState("run",x)}}class u{constructor(t){this._parent=t}Enter(){}Exit(){}Update(){}}class S extends u{constructor(t){super(t)}get Name(){return"walk"}Enter(t){const e=this._parent._proxy._animations.walk.action;if(t){const i=this._parent._proxy._animations[t.Name].action;if(e.enabled=!0,t.Name=="run"){const s=e.getClip().duration/i.getClip().duration;e.time=i.time*s}else e.time=0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1);e.crossFadeFrom(i,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){if(e._keys.forward||e._keys.backward){e._keys.shift&&this._parent.SetState("run");return}this._parent.SetState("idle")}}class x extends u{constructor(t){super(t)}get Name(){return"run"}Enter(t){const e=this._parent._proxy._animations.run.action;if(t){const i=this._parent._proxy._animations[t.Name].action;if(e.enabled=!0,t.Name=="walk"){const s=e.getClip().duration/i.getClip().duration;e.time=i.time*s}else e.time=0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1);e.crossFadeFrom(i,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){if(e._keys.forward||e._keys.backward){e._keys.shift||this._parent.SetState("walk");return}this._parent.SetState("idle")}}class b extends u{constructor(t){super(t)}get Name(){return"idle"}Enter(t){const e=this._parent._proxy._animations.idle.action;if(t){const i=this._parent._proxy._animations[t.Name].action;e.time=0,e.enabled=!0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1),e.crossFadeFrom(i,.5,!0),e.play()}else e.play()}Exit(){}Update(t,e){e._keys.forward||e._keys.backward?this._parent.SetState("walk"):e._keys.space&&this._parent.SetState("dance")}}class A{constructor(){this._Initialize()}_Initialize(){this._threejs=new r.WebGLRenderer({antialias:!0}),this._threejs.outputEncoding=r.sRGBEncoding,this._threejs.shadowMap.enabled=!0,this._threejs.shadowMap.type=r.PCFSoftShadowMap,this._threejs.setPixelRatio(window.devicePixelRatio),this._threejs.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this._threejs.domElement),window.addEventListener("resize",()=>{this._OnWindowResize()},!1);const t=60,e=1920/1080,i=1,s=1e3;this._camera=new r.PerspectiveCamera(t,e,i,s),this._camera.position.set(0,40,-40),this._scene=new r.Scene;let a=new r.DirectionalLight(16777215,1);a.position.set(-100,100,100),a.target.position.set(0,0,0),a.castShadow=!0,a.shadow.bias=-.001,a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096,a.shadow.camera.near=.1,a.shadow.camera.far=500,a.shadow.camera.near=.5,a.shadow.camera.far=500,a.shadow.camera.left=50,a.shadow.camera.right=-50,a.shadow.camera.top=50,a.shadow.camera.bottom=-50,this._scene.add(a),a=new r.AmbientLight(16777215,.25),this._scene.add(a);const n=new m(this._camera,this._threejs.domElement);n.target.set(0,10,0),n.update(),this._group=new r.Group,this._group.add(this._camera);const o=new r.Mesh(new r.PlaneGeometry(100,100,10,10),new r.MeshStandardMaterial({color:8421504}));o.castShadow=!1,o.receiveShadow=!0,o.rotation.x=-Math.PI/2,this._scene.add(o),this._mixers=[],this._previousRAF=null,this._LoadAnimatedModel(),this._RAF()}_LoadAnimatedModel(){const t={camera:this._camera,scene:this._scene};this._controls=new f(t)}_LoadAnimatedModelAndPlay(t,e,i,s){const a=new p;a.setPath(t),a.load(e,n=>{n.scale.setScalar(.1),n.traverse(h=>{h.castShadow=!0}),n.position.copy(s);const o=new p;o.setPath(t),o.load(i,h=>{const l=new r.AnimationMixer(n);this._mixers.push(l),l.clipAction(h.animations[0]).play()}),this._scene.add(n)})}_OnWindowResize(){this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._threejs.setSize(window.innerWidth,window.innerHeight)}_RAF(){requestAnimationFrame(t=>{this._previousRAF===null&&(this._previousRAF=t),this._RAF(),this._threejs.render(this._scene,this._camera),this._Step(t-this._previousRAF),this._previousRAF=t})}_Step(t){const e=t*.001;this._mixers&&this._mixers.map(i=>i.update(e)),this._controls&&this._controls.Update(e)}}window.addEventListener("DOMContentLoaded",()=>{new A});
