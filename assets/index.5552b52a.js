import*as r from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";import{FBXLoader as u}from"https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/FBXLoader.js";import{OrbitControls as m}from"https://cdn.jsdelivr.net/npm/three@0.118/examples/jsm/controls/OrbitControls.js";const f=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}};f();class w{constructor(e){this._animations=e}get animations(){return this._animations}}class y{constructor(e){this._Init(e),this._currentModel=null}_Init(e){const t=document.getElementById("character-model-select"),n=document.querySelector(".select-container"),s=document.getElementById("enter-button"),i=document.querySelector(".button-container"),a=document.querySelector(".exit-button-container");a.addEventListener("click",function(){i.style.display="flex",n.style.display="none",a.style.display="none"}),s.addEventListener("click",function(){i.style.display="none",n.style.display="flex",a.style.display="flex"}),t.addEventListener("change",o=>{if(this._params=e,this._decceleration=new r.Vector3(-5e-4,-1e-4,-5),this._acceleration=new r.Vector3(1,.25,50),this._velocity=new r.Vector3(0,0,0),this._animations={},this._input=new g,this._stateMachine=new S(new w(this._animations)),this._currentModel=this._target,o.target.value==="none")return this._params.scene.remove(this._currentModel);this._params.scene.remove(this._currentModel),this._LoadModels(o.target.value)})}_LoadModels(e){const t=new u;t.setPath("./src/models/characters/"),t.load(e,n=>{n.scale.setScalar(.1),n.traverse(a=>{a.castShadow=!0}),this._target=n,this._params.scene.add(this._target),this._mixer=new r.AnimationMixer(this._target),this._manager=new r.LoadingManager,this._manager.onLoad=()=>{this._stateMachine.SetState("idle")};const s=(a,o)=>{const l=o.animations[0],d=this._mixer.clipAction(l);this._animations[a]={clip:l,action:d}},i=new u(this._manager);i.setPath("./src/models/animations/"),i.load("Walking.fbx",a=>{s("walk",a)}),i.load("Running_Backward.fbx",a=>{s("walk_backward",a)}),i.load("Running.fbx",a=>{s("run",a)}),i.load("Running_Backward.fbx",a=>{s("run_backward",a)}),i.load("Idle.fbx",a=>{s("idle",a)})})}Update(e){if(!this._target)return;this._stateMachine.Update(e,this._input);const t=this._velocity,n=new r.Vector3(t.x*this._decceleration.x,t.y*this._decceleration.y,t.z*this._decceleration.z);n.multiplyScalar(e),n.z=Math.sign(n.z)*Math.min(Math.abs(n.z),Math.abs(t.z)),t.add(n);const s=this._target,i=new r.Quaternion,a=new r.Vector3,o=s.quaternion.clone(),l=this._acceleration.clone();this._input._keys.shift&&l.multiplyScalar(2),this._input._keys.forward&&(t.z+=l.z*e),this._input._keys.backward&&(t.z-=l.z*e),this._input._keys.left&&(a.set(0,1,0),i.setFromAxisAngle(a,4*Math.PI*e*this._acceleration.y),o.multiply(i)),this._input._keys.right&&(a.set(0,1,0),i.setFromAxisAngle(a,4*-Math.PI*e*this._acceleration.y),o.multiply(i)),s.quaternion.copy(o);const d=new r.Vector3;d.copy(s.position);const h=new r.Vector3(0,0,1);h.applyQuaternion(s.quaternion),h.normalize();const _=new r.Vector3(1,0,0);_.applyQuaternion(s.quaternion),_.normalize(),_.multiplyScalar(t.x*e),h.multiplyScalar(t.z*e),s.position.add(h),s.position.add(_),d.copy(s.position),this._mixer&&this._mixer.update(e)}}class g{constructor(){this._Init()}_Init(){this._keys={forward:!1,backward:!1,left:!1,right:!1,space:!1,shift:!1},document.addEventListener("keydown",e=>this._onKeyDown(e),!1),document.addEventListener("keyup",e=>this._onKeyUp(e),!1)}_onKeyDown(e){switch(e.keyCode){case 87:this._keys.forward=!0;break;case 65:this._keys.left=!0;break;case 83:this._keys.backward=!0;break;case 68:this._keys.right=!0;break;case 16:this._keys.shift=!0;break}}_onKeyUp(e){switch(e.keyCode){case 87:this._keys.forward=!1;break;case 65:this._keys.left=!1;break;case 83:this._keys.backward=!1;break;case 68:this._keys.right=!1;break;case 16:this._keys.shift=!1;break}}}class k{constructor(){this._states={},this._currentState=null}_AddState(e,t){this._states[e]=t}SetState(e){const t=this._currentState;if(t){if(t.Name==e)return;t.Exit()}const n=new this._states[e](this);this._currentState=n,n.Enter(t)}Update(e,t){this._currentState&&this._currentState.Update(e,t)}}class S extends k{constructor(e){super(),this._proxy=e,this._Init()}_Init(){this._AddState("idle",E),this._AddState("walk",x),this._AddState("run",b)}}class p{constructor(e){this._parent=e}Enter(){}Exit(){}Update(){}}class x extends p{constructor(e){super(e)}get Name(){return"walk"}Enter(e){const t=this._parent._proxy._animations.walk.action;if(e){const n=this._parent._proxy._animations[e.Name].action;if(t.enabled=!0,e.Name=="run"){const s=t.getClip().duration/n.getClip().duration;t.time=n.time*s}else t.time=0,t.setEffectiveTimeScale(1),t.setEffectiveWeight(1);t.crossFadeFrom(n,.5,!0),t.play()}else t.play()}Exit(){}Update(e,t){if(t._keys.forward||t._keys.backward){t._keys.shift&&this._parent.SetState("run");return}this._parent.SetState("idle")}}class b extends p{constructor(e){super(e)}get Name(){return"run"}Enter(e){const t=this._parent._proxy._animations.run.action;if(e){const n=this._parent._proxy._animations[e.Name].action;if(t.enabled=!0,e.Name=="walk"){const s=t.getClip().duration/n.getClip().duration;t.time=n.time*s}else t.time=0,t.setEffectiveTimeScale(1),t.setEffectiveWeight(1);t.crossFadeFrom(n,.5,!0),t.play()}else t.play()}Exit(){}Update(e,t){if(t._keys.forward||t._keys.backward){t._keys.shift||this._parent.SetState("walk");return}this._parent.SetState("idle")}}class E extends p{constructor(e){super(e)}get Name(){return"idle"}Enter(e){const t=this._parent._proxy._animations.idle.action;if(e){const n=this._parent._proxy._animations[e.Name].action;t.time=0,t.enabled=!0,t.setEffectiveTimeScale(1),t.setEffectiveWeight(1),t.crossFadeFrom(n,.5,!0),t.play()}else t.play()}Exit(){}Update(e,t){(t._keys.forward||t._keys.backward)&&this._parent.SetState("walk")}}class A{constructor(){this._Initialize()}_Initialize(){this._threejs=new r.WebGLRenderer({antialias:!0}),this._threejs.outputEncoding=r.sRGBEncoding,this._threejs.shadowMap.enabled=!0,this._threejs.shadowMap.type=r.PCFSoftShadowMap,this._threejs.setPixelRatio(window.devicePixelRatio),this._threejs.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this._threejs.domElement),window.addEventListener("resize",()=>{this._OnWindowResize()},!1);const e=60,t=1920/1080,n=1,s=1e3;this._camera=new r.PerspectiveCamera(e,t,n,s),this._camera.position.set(0,40,-40),this._scene=new r.Scene;let i=new r.DirectionalLight(16777215,1);i.position.set(-100,100,100),i.target.position.set(0,0,0),i.castShadow=!0,i.shadow.bias=-.001,i.shadow.mapSize.width=4096,i.shadow.mapSize.height=4096,i.shadow.camera.near=.1,i.shadow.camera.far=500,i.shadow.camera.near=.5,i.shadow.camera.far=500,i.shadow.camera.left=50,i.shadow.camera.right=-50,i.shadow.camera.top=50,i.shadow.camera.bottom=-50,this._scene.add(i),i=new r.AmbientLight(16777215,.25),this._scene.add(i);const a=new m(this._camera,this._threejs.domElement);a.target.set(0,10,0),a.update(),this._group=new r.Group,this._group.add(this._camera);const o=new r.Mesh(new r.PlaneGeometry(100,100,10,10),new r.MeshStandardMaterial({color:8421504}));o.castShadow=!1,o.receiveShadow=!0,o.rotation.x=-Math.PI/2,this._scene.add(o),this._mixers=[],this._previousRAF=null,this._LoadAnimatedModel(),this._RAF()}_LoadAnimatedModel(){const e={camera:this._camera,scene:this._scene};this._controls=new y(e)}_LoadAnimatedModelAndPlay(e,t,n,s){const i=new u;i.setPath(e),i.load(t,a=>{a.scale.setScalar(.1),a.traverse(l=>{l.castShadow=!0}),a.position.copy(s);const o=new u;o.setPath(e),o.load(n,l=>{const d=new r.AnimationMixer(a);this._mixers.push(d),d.clipAction(l.animations[0]).play()}),this._scene.add(a)})}_OnWindowResize(){this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._threejs.setSize(window.innerWidth,window.innerHeight)}_RAF(){requestAnimationFrame(e=>{this._previousRAF===null&&(this._previousRAF=e),this._RAF(),this._threejs.render(this._scene,this._camera),this._Step(e-this._previousRAF),this._previousRAF=e})}_Step(e){const t=e*.001;this._mixers&&this._mixers.map(n=>n.update(t)),this._controls&&this._controls.Update(t)}}window.addEventListener("DOMContentLoaded",()=>{new A});
